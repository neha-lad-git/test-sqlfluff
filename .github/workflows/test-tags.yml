name: test-tags
 
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select the environment to deploy to'
        required: true
        default: 'TEST'
        type: choice
        options:
          - TEST
          - STG
          - PRD
      release_version:  
        description: 'Select the release version'
        required: false
        default: ''
      project_name:
        type: choice
        description: 'Select the project you wish to deploy'
        default: ''
        required: true
        options:
          - WATER_DM
          - OPERATIONS_DM
          - SOURCE_DM
          - COMMON_DM
          - WQD_DM
          - ENERGY_DM

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Set up environment
      run: |
        echo "RELEASE_VERSION=${{ github.event.inputs.release_version }}" >> $GITHUB_ENV

    - name: Get available releases
      id: get_releases
												   
      uses: actions/github-script@v4
      with:
        script: |
          const releases = await github.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          return releases.data.map(release => release.tag_name);
      continue-on-error: true

    - name: Set release version
      if: github.event.inputs.release_version == ''
      run: echo "RELEASE_VERSION=${{ steps.get_releases.outputs.result[0] }}" >> $GITHUB_ENV

    - name: Ensure permissions
      run: chmod -R u+rwx ${{ github.workspace }}

    - name: Remove anything
      if: always()
      run: |
        rm -rf ${{ github.workspace }}/*
    
    - name: Download and extract release asset
      uses: robinraju/release-downloader@v1
      with:
        repository: ${{ github.repository }}
        tag: ${{ env.RELEASE_VERSION }}
        fileName: 'ADW-${{ env.RELEASE_VERSION }}.zip'
        latest: false
        extract: true

    - name: Print Home
      run: |
        ls -lrt


										   
